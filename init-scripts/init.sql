-- Início do Script de Inicialização Completo

SET statement_timeout = 0;
SET lock_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

-- 1. Criar o esquema
CREATE SCHEMA appwtg;

-- 2. Criar os tipos customizados
CREATE TYPE appwtg.plan_status AS ENUM ('inactive', 'active', 'paused', 'readytoactive');
CREATE TYPE appwtg.plan_type AS ENUM ('weekly', 'monthly', 'anual', 'free', 'partner');
CREATE TYPE appwtg.user_type AS ENUM ('usuario', 'parceiro', 'premium', 'admin');

-- 3. Criar as tabelas
CREATE TABLE appwtg.account (
    id bigint NOT NULL, user_name character varying(100) NOT NULL, email character varying(150) NOT NULL,
    password character varying(255), confirm_password character varying(255), token character varying(255),
    second_email character varying(150), created_at timestamp without time zone DEFAULT now(),
    updated_at timestamp without time zone DEFAULT now(), last_login timestamp without time zone,
    email_verified boolean, login_provider character varying(50), locale character varying(50),
    login_sub character varying(100), active boolean DEFAULT true
);

CREATE TABLE appwtg.address (
    id bigint NOT NULL, address character varying(200), number integer, complement character varying(200),
    obs character varying(1000), reference character varying(200), postal_code character varying(100)
);

CREATE TABLE appwtg.card (
    id bigint NOT NULL, wallet_id bigint NOT NULL, card_name character varying(100) NOT NULL, ccv integer,
    expires_at date NOT NULL, doc_titular character varying(50) NOT NULL, card_band character varying(50) NOT NULL,
    created_at timestamp with time zone DEFAULT now(), updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT card_ccv_check CHECK (((ccv >= 100) AND (ccv <= 999)))
);

CREATE TABLE appwtg.plan (
    id bigint NOT NULL, plan_name character varying(100), value numeric(10,2), type appwtg.plan_type
);

CREATE TABLE appwtg.promotion (
    id bigint NOT NULL, user_id bigint NOT NULL, title character varying(255) NOT NULL, description character varying(2000),
    free boolean DEFAULT false, obs character varying(1000), created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP, address_id bigint,
    allow_user_active_promotion boolean DEFAULT false, active boolean DEFAULT false
);

CREATE TABLE appwtg."user" (
    id bigint NOT NULL, first_name character varying(100) NOT NULL, full_name character varying(200) NOT NULL,
    birthday date, active boolean DEFAULT true, account_id bigint, phone character varying(50),
    token character varying(200), created_at timestamp without time zone DEFAULT now(),
    updated_at timestamp without time zone DEFAULT now(), picture_url character varying(500), user_type appwtg.user_type
);

CREATE TABLE appwtg.user_plan (
    id bigint NOT NULL, user_id bigint, plan_id bigint, started_at timestamp with time zone, finish_at timestamp with time zone,
    status appwtg.plan_status DEFAULT 'active'::appwtg.plan_status NOT NULL, payment_made boolean DEFAULT false,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP, updated_at timestamp without time zone
);

CREATE TABLE appwtg.wallet (
    id bigint NOT NULL, user_id bigint NOT NULL, created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);
-- Adicione este bloco ao seu arquivo init.sql

-- 1. CRIAR A NOVA TABELA PARA AS IMAGENS DA PROMOÇÃO
CREATE TABLE appwtg.promotion_image (
    id BIGINT NOT NULL,
    promotion_id BIGINT NOT NULL,
    s3_key VARCHAR(255) NOT NULL,
    upload_order INTEGER NOT NULL,
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP
);


-- 4. Criar as sequences
CREATE SEQUENCE appwtg.account_id_seq AS integer;
ALTER TABLE ONLY appwtg.account ALTER COLUMN id SET DEFAULT nextval('appwtg.account_id_seq'::regclass);

-- 2. CRIAR A SEQUENCE PARA O ID DA NOVA TABELA
CREATE SEQUENCE appwtg.promotion_image_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;
ALTER TABLE ONLY appwtg.promotion_image ALTER COLUMN id SET DEFAULT nextval('appwtg.promotion_image_id_seq'::regclass);


CREATE SEQUENCE appwtg.address_id_seq AS integer;
ALTER TABLE ONLY appwtg.address ALTER COLUMN id SET DEFAULT nextval('appwtg.address_id_seq'::regclass);

CREATE SEQUENCE appwtg.card_id_seq;
ALTER TABLE ONLY appwtg.card ALTER COLUMN id SET DEFAULT nextval('appwtg.card_id_seq'::regclass);

ALTER TABLE appwtg.plan ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (SEQUENCE NAME appwtg.plan_id_seq);

CREATE SEQUENCE appwtg.promotion_id_seq AS integer;
ALTER TABLE ONLY appwtg.promotion ALTER COLUMN id SET DEFAULT nextval('appwtg.promotion_id_seq'::regclass);

CREATE SEQUENCE appwtg.user_id_seq AS integer;
ALTER TABLE ONLY appwtg."user" ALTER COLUMN id SET DEFAULT nextval('appwtg.user_id_seq'::regclass);

ALTER TABLE appwtg.user_plan ALTER COLUMN id ADD GENERATED ALWAYS AS IDENTITY (SEQUENCE NAME appwtg.user_plan_id_seq);

CREATE SEQUENCE appwtg.wallet_id_seq;
ALTER TABLE ONLY appwtg.wallet ALTER COLUMN id SET DEFAULT nextval('appwtg.wallet_id_seq'::regclass);

-- 5. Inserir os dados
COPY appwtg.account (id, user_name, email, password, confirm_password, token, second_email, created_at, updated_at, last_login, email_verified, login_provider, locale, login_sub, active) FROM stdin;
1	teste1.souza	teste1.teste@example.com	$2a$10$jVs7SozPuX9QI87Y.Mryve2R/cJsU54BzkoPRpaBwh41i4LNRe7BO	\N	\N	\N	2025-09-24 17:12:20.477808	2025-09-24 17:12:20.477808	\N	\N	\N	\N	\N	t
2	teste2.souza	teste2.teste@example.com	$2a$10$ZaBHd34Mxmuns2BaU5fvh.br/b55c/BsLEAS5/iud8fN5uJIqxrpa	\N	\N	\N	2025-09-24 17:19:05.882294	2025-09-24 17:19:05.882294	\N	\N	\N	\N	\N	t
3	ana.carolina	ana.carolina@example.com	$2a$10$t989qLihbZTcB6c4nbCqGOSatPqyCUZWr.zs.l.d10tNXCUYGprpm	\N	\N	\N	2025-09-24 17:25:37.904055	2025-09-24 17:25:37.904055	\N	\N	\N	\N	\N	t
4	joao.carolina	joao.carolina@example.com	$2a$10$GnKEnDxWCdgb3V9CJegNmuhjSGMJdRmy5HF3uLfH8PyOlZX/F6jJu	\N	\N	\N	2025-09-24 17:27:57.790508	2025-09-24 17:27:57.790508	\N	\N	\N	\N	\N	t
5	joana.carolina	joana.carolina@example.com	$2a$10$yt5Qg5IWBRFHOkIr3HFJkex4UA0OQ14DmIvQKG0C53qn0DHinVi3K	\N	\N	\N	2025-09-24 17:49:33.043127	2025-09-24 17:49:33.043127	\N	\N	\N	\N	\N	t
6	cadu.carolina	cadu.carolina@example.com	$2a$10$9NBhoiint2cTuYRIsuOCiOQ/V9wO1XJdUQQjf4fglR6uFdotiCtuO	\N	\N	\N	2025-09-24 18:04:07.524361	2025-09-24 18:04:07.524361	\N	\N	\N	\N	\N	t
7	laura.carolina	laura.carolina@example.com	$2a$10$2vL2K/or9WLITKcqEBytzOcvocjGaAB2/28IwRu8O3Rcdf/4FWJ9m	\N	\N	\N	2025-09-24 18:04:26.084053	2025-09-24 18:04:26.084053	\N	\N	\N	\N	\N	t
8	Suely.carolina	Suely.carolina@example.com	$2a$10$EkxgRJBDAl6SlKDy6jedAODzgZsDY.lE3owAXbTQmMdQaIow5i5Wm	\N	\N	\N	2025-09-24 18:06:46.320413	2025-09-24 18:06:46.320413	\N	\N	\N	\N	\N	t
9	Mai.carolina	Mai.carolina@example.com	$2a$10$lzNFY.TRA.30DvDz34RgVONlwD59p8DhXbk8GqKYxQ.AUP2Hx76xq	\N	\N	\N	2025-09-24 18:07:21.361332	2025-09-24 18:07:21.361332	\N	\N	\N	\N	\N	t
10	ester.carolina	ester.carolina@example.com	$2a$10$rxwUXziSBSjtJRIQUDsRkOPLJoktifDsxtg/VJyZMQRoxNNDDT8fa	\N	\N	\N	2025-09-24 18:08:53.793148	2025-09-24 18:08:53.793148	\N	\N	\N	\N	\N	t
11	sandra.carolina	sandra.carolina@example.com	$2a$10$AvcAeCJHwVQVPc9ZNRiPSezSiNAbOhCCH0OuwZ33Q8L4DRsDcgmL6	\N	\N	\N	2025-09-24 18:10:26.195771	2025-09-24 18:10:26.195771	\N	\N	\N	\N	\N	t
\.

COPY appwtg.address (id, address, number, complement, obs, reference, postal_code) FROM stdin;
1	Rua das Flores	123	Apto 45	venham trajados!	Próximo à padaria	50000-123
2	Rua das Flores	123	Apto 45	venham trajados!	Próximo à padaria	50000-123
4	Rua das Flores	123	Apto 45	venham trajados!	Próximo à padaria	50000-123
5	Rua das Flores	123	Apto 45	venham trajados!	Próximo à padaria	50000-123
6	Rua das parques	123	Apto 47	venham trajadossssss!	Próximo à padaria	50000-123
7	Rua das parques	123	Apto 47	venham trajadossssss!	Próximo à padaria	50000-123
8	Rua das parques	123	Apto 47	venham trajadossssss!	Próximo à padaria	50000-123
9	Avenida Boa Viagem	1234	Apto 101	Entregar em horário comercial.	Próximo à padaria	51020-000
10	Avenida Boa Viagem	1234	Apto 101	Entregar em horário comercial.	Próximo à padaria	51020-000
11	Avenida Boa Viagem	1234	Apto 101	Entregar em horário comercial.	Próximo à padaria	51020-000
12	Rua das Flores	123	Apto 45	venham trajadossssss!	Próximo à padaria	50000-123
13	Rua das parques	123	Apto 47	venham trajadossssss!	Próximo à padaria	50000-123
\.

COPY appwtg.plan (id, plan_name, value, type) FROM stdin;
1	Semanal	10.00	weekly
2	Mensal	30.00	monthly
3	Anual	250.00	anual
4	Gratuito	0.00	free
5	Parceiro	0.00	partner
\.

COPY appwtg."user" (id, first_name, full_name, birthday, active, account_id, phone, token, created_at, updated_at, picture_url, user_type) FROM stdin;
1	Teste1	Teste1 Souza	\N	t	1	\N	\N	2025-09-24 17:12:20.448262	2025-09-24 17:12:20.448262	\N	\N
2	Teste2	Teste2 Souza	\N	t	2	\N	\N	2025-09-24 17:19:05.855439	2025-09-24 17:19:05.855439	\N	\N
3	Ana	Ana Carolina	\N	t	3	\N	\N	2025-09-24 17:25:37.902649	2025-09-24 17:25:37.902649	\N	\N
4	Joao	Joao Carolina	\N	t	4	\N	\N	2025-09-24 17:27:57.789448	2025-09-24 17:27:57.789448	\N	\N
5	joana	joana Carolina	\N	t	5	\N	\N	2025-09-24 17:49:33.020869	2025-09-24 17:49:33.020869	\N	\N
6	cadu	cadu Carolina	\N	t	6	\N	\N	2025-09-24 18:04:07.511869	2025-09-24 18:04:07.511869	\N	\N
7	laura	laura Carolina	\N	t	7	\N	\N	2025-09-24 18:04:26.083863	2025-09-24 18:04:26.083863	\N	\N
8	Suely	Suely Carolina	\N	t	8	\N	\N	2025-09-24 18:06:46.320184	2025-09-24 18:06:46.320184	\N	\N
9	Mai	Mai Carolina	\N	t	9	\N	\N	2025-09-24 18:07:21.360594	2025-09-24 18:07:21.360594	\N	\N
10	ester	ester Carolina	\N	t	10	\N	\N	2025-09-24 18:08:53.79298	2025-09-24 18:08:53.79298	\N	\N
11	sandra	sandra Carolina	\N	t	11	\N	\N	2025-09-24 18:10:26.195597	2025-09-24 18:10:26.195597	\N	\N
\.

COPY appwtg.promotion (id, user_id, title, description, free, obs, created_at, updated_at, address_id, allow_user_active_promotion, active) FROM stdin;
1	1	Promoção de Lançamento	Desconto especial para os primeiros clientes da plataforma.	f	Válido apenas para novos cadastros.	2025-09-24 17:12:58.437489	2025-09-24 17:14:36.707463	5	t	t
2	2	Promoção de Lançamento	Desconto especial para os primeiros clientes da plataforma.	f	Válido apenas para novos cadastros.	2025-09-24 17:19:29.439737	2025-09-24 17:20:05.889055	6	t	t
3	3	Promoção de Lançamento	Desconto especial para os primeiros clientes da plataforma.	f	Válido apenas para novos cadastros.	2025-09-24 17:25:37.907886	2025-09-24 17:27:01.109606	7	t	t
4	4	Promoção de Lançamento	Desconto especial para os primeiros clientes da plataforma.	f	Válido apenas para novos cadastros.	2025-09-24 17:27:57.804275	2025-09-24 17:29:07.46778	8	t	t
5	5	Promoção de Inauguração	20% de desconto para novos usuários.	t	Válido apenas para o primeiro mês.	2025-09-24 17:49:33.156945	2025-09-24 17:49:33.156945	9	t	f
6	8	Promoção de Inauguração	20% de desconto para novos usuários.	t	Válido apenas para o primeiro mês.	2025-09-24 18:06:46.370689	2025-09-24 18:06:46.370689	10	t	t
7	9	Promoção de Inauguração	20% de desconto para novos usuários.	t	Válido apenas para o primeiro mês.	2025-09-24 18:07:21.369485	2025-09-24 18:07:21.369485	11	t	f
8	10	Promoção de Lançamento	Desconto especial para os primeiros clientes da plataforma.	f	\N	2025-09-24 18:09:51.156042	2025-09-24 18:09:51.156042	12	t	t
9	11	Promoção de Lançamento	Desconto especial para os primeiros clientes da plataforma.	f	Válido aaaaapenas para novos cadastros.	2025-09-24 18:10:38.264465	2025-09-24 19:25:11.597015	13	f	f
\.

COPY appwtg.user_plan (id, user_id, plan_id, started_at, finish_at, status, payment_made, created_at, updated_at) FROM stdin;
1	1	4	2025-09-24 17:14:36.661329-03	2025-09-25 17:14:36.661329-03	active	\N	2025-09-24 17:12:20.6399	2025-09-24 17:14:36.708515
2	2	4	2025-09-24 17:20:05.870961-03	2025-09-25 17:20:05.870961-03	active	\N	2025-09-24 17:19:05.961916	2025-09-24 17:20:05.88935
3	3	4	2025-09-24 17:27:00.882725-03	2025-09-25 17:27:00.882725-03	active	\N	2025-09-24 17:25:37.915341	2025-09-24 17:27:01.110226
4	4	4	2025-09-24 17:29:07.455052-03	2025-09-25 17:29:07.455052-03	active	\N	2025-09-24 17:27:57.81803	2025-09-24 17:29:07.468075
5	5	4	\N	\N	readytoactive	\N	2025-09-24 17:49:33.18746	2025-09-24 17:49:33.18746
6	4	2	2025-09-25 17:29:07.455052-03	2025-10-25 17:29:07.455052-03	readytoactive	\N	2025-09-24 17:52:19.33124	2025-09-24 17:52:19.33124
7	4	2	2025-09-25 17:29:07.455052-03	2025-10-25 17:29:07.455052-03	readytoactive	\N	2025-09-24 17:54:09.672358	2025-09-24 17:54:09.672358
8	4	5	2025-09-25 17:29:07.455052-03	2026-09-25 17:29:07.455052-03	readytoactive	\N	2025-09-24 18:01:14.72233	2025-09-24 18:01:14.72233
9	6	4	\N	\N	readytoactive	\N	2025-09-24 18:04:07.550715	2025-09-24 18:04:07.550715
10	7	4	\N	\N	readytoactive	\N	2025-09-24 18:04:26.087487	2025-09-24 18:04:26.087487
11	8	4	2025-09-24 18:06:46.317547-03	2025-09-25 18:06:46.317547-03	active	\N	2025-09-24 18:06:46.384147	2025-09-24 18:06:46.384147
12	9	4	\N	\N	readytoactive	\N	2025-09-24 18:07:21.3732	2025-09-24 18:07:21.3732
13	10	4	2025-09-24 18:09:51.151977-03	2025-09-25 18:09:51.151977-03	active	\N	2025-09-24 18:08:53.79774	2025-09-24 18:09:51.161548
14	11	4	2025-09-24 18:13:13.745384-03	2025-09-25 18:13:13.745384-03	active	\N	2025-09-24 18:10:26.199577	2025-09-24 18:13:13.749409
\.

-- 6. Configurar as chaves primárias e estrangeiras
ALTER TABLE ONLY appwtg.account ADD CONSTRAINT account_pkey PRIMARY KEY (id);
ALTER TABLE ONLY appwtg.address ADD CONSTRAINT address_pkey PRIMARY KEY (id);
ALTER TABLE ONLY appwtg.card ADD CONSTRAINT card_pkey PRIMARY KEY (id);
ALTER TABLE ONLY appwtg.plan ADD CONSTRAINT plan_pkey PRIMARY KEY (id);
ALTER TABLE ONLY appwtg.promotion ADD CONSTRAINT promotion_pkey PRIMARY KEY (id);
ALTER TABLE ONLY appwtg."user" ADD CONSTRAINT user_pkey PRIMARY KEY (id);
ALTER TABLE ONLY appwtg.user_plan ADD CONSTRAINT user_plan_pkey PRIMARY KEY (id);
ALTER TABLE ONLY appwtg.wallet ADD CONSTRAINT wallet_pkey PRIMARY KEY (id);

ALTER TABLE ONLY appwtg.promotion ADD CONSTRAINT promotion_address_id_key UNIQUE (address_id);
ALTER TABLE ONLY appwtg."user" ADD CONSTRAINT uq_user_account UNIQUE (account_id);
ALTER TABLE ONLY appwtg.wallet ADD CONSTRAINT wallet_user_id_key UNIQUE (user_id);

ALTER TABLE ONLY appwtg."user" ADD CONSTRAINT fk_account FOREIGN KEY (account_id) REFERENCES appwtg.account(id) ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE ONLY appwtg.card ADD CONSTRAINT fk_card_wallet FOREIGN KEY (wallet_id) REFERENCES appwtg.wallet(id) ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE ONLY appwtg.promotion ADD CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES appwtg."user"(id) ON DELETE CASCADE;
ALTER TABLE ONLY appwtg.wallet ADD CONSTRAINT fk_wallet_user FOREIGN KEY (user_id) REFERENCES appwtg."user"(id) ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE ONLY appwtg.user_plan ADD CONSTRAINT user_plan_plan_id_fkey FOREIGN KEY (plan_id) REFERENCES appwtg.plan(id);
ALTER TABLE ONLY appwtg.user_plan ADD CONSTRAINT user_plan_user_id_fkey FOREIGN KEY (user_id) REFERENCES appwtg."user"(id);
-- 3. DEFINIR A CHAVE PRIMÁRIA
ALTER TABLE ONLY appwtg.promotion_image
    ADD CONSTRAINT promotion_image_pkey PRIMARY KEY (id);
-- 4. CRIAR A RELAÇÃO (CHAVE ESTRANGEIRA)
ALTER TABLE ONLY appwtg.promotion_image
    ADD CONSTRAINT fk_promotion_image_promotion FOREIGN KEY (promotion_id) REFERENCES appwtg.promotion(id) ON DELETE CASCADE;

-- Fim do bloco a ser adicionado
-- Bloco CORRIGIDO para Sincronizar TODAS as sequências
DO $$
DECLARE
    r RECORD;
    tableName TEXT;
BEGIN
    FOR r IN (SELECT relname FROM pg_class WHERE relkind = 'S' AND relnamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'appwtg')) LOOP
        -- Lógica para encontrar o nome da tabela a partir do nome da sequência
        tableName := REPLACE(r.relname, '_id_seq', '');

        -- Citação correta do nome da tabela para segurança
        EXECUTE 'SELECT setval(''' || 'appwtg."' || r.relname || '"''' || ', (SELECT COALESCE(MAX(id), 1) FROM appwtg."' || tableName || '"), true)';
    END LOOP;
END $$;

-- Fim do Script